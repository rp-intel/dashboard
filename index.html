<!DOCTYPE HTML>
<html>
<head>
    <title>RP Intel Homepage</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <link rel="stylesheet" href="assets/css/main.css" />
    <style>
        /* Styles for the dynamic analysis section */
        #analysis-container {
            margin-top: 2rem;
        }
        .source-block {
            margin-bottom: 2rem;
            padding-left: 0;
        }
        .source-block > h1 {
            font-size: 1.8rem;
            color: #223344;
            border-bottom: 2px solid #003366;
            padding-bottom: 0.3rem;
        }
        .article-block {
            margin-left: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .article-block > h2 {
            font-size: 1.4rem;
            color: #223344;
            margin-bottom: 0.2rem;
        }
        .article-date {
            font-size: 0.95rem;
            color: #666;
            margin-bottom: 0.5rem;
        }
        .analysis-block {
            margin-left: 3rem;
            margin-bottom: 1rem;
        }
        .analysis-block > h3 {
            font-size: 1.2rem;
            color: #223344;
            margin-bottom: 0.2rem;
        }
        .analysis-block > p {
            font-size: 1rem;
            line-height: 1.4;
            color: #222;
            margin-top: 0;
        }
    </style>
</head>
<body class="is-preload">

    <!-- Content -->
    <div id="content">
        <div class="inner">
            <!-- Dynamic analysis section -->
            <section class="box post post-excerpt">
                <img src="images/redcon_prop.png" alt="Description" style="max-width:100%; height:auto; margin-bottom: 1rem;" />
                <header>
                    <h2 style="color: #223344;">The Latest From Our Sources</h2>
                </header>
                <div id="analysis-container">
                    <!-- Dynamic content injected here -->
                </div>
            </section>
        </div>
    </div>

    <!-- Sidebar -->
    <div id="sidebar">
        <h1 id="logo"><a href="#">RP INTEL</a></h1>
        <nav id="nav">
            <ul>
                <li class="current"><a href="#">Today's Roundup</a></li>
            </ul>
        </nav>

        <section class="box text-style1">
            <div class="inner">
                <p><strong>RP Intel:</strong> Your personal intelligence system designed to keep you informed</p>
            </div>
        </section>

        <section class="box local-sources">
            <header><h2>Local Sources</h2></header>
            <ul>
                <li><a href="https://enterprise.news/egypt/en">Enterprise News MENA</a></li>
                <li><a href="https://english.ahram.org.eg/">Al Ahram</a></li>
                <li><a href="https://www.dailynewsegypt.com/">Daily News Egypt</a></li>
                <li><a href="https://www.egyptindependent.com/">Egypt Independent</a></li>
                <li><a href="https://egyptian-gazette.com/">The Egyptian Gazzette</a></li>
            </ul>
        </section>

        <section class="box international-sources">
            <header><h2>International Sources</h2></header>
            <ul>
                <li><a href="https://edition.cnn.com/">CNN</a></li>
                <li><a href="https://www.bbc.com/">BBC</a></li>
                <li><a href="https://www.nytimes.com/">The New York Times</a></li>
                <li><a href="https://www.bloomberg.com/middleeast">Bloomberg</a></li>
                <li><a href="https://www.foxnews.com/">Fox News</a></li>
            </ul>
        </section>

        <ul id="copyright">
            <li>&copy;</li><li>Design: <a href="http://html5up.net">HTML5 UP</a></li>
        </ul>
    </div>

    <!-- Scripts -->
    <script src="assets/js/jquery.min.js"></script>
    <script src="assets/js/browser.min.js"></script>
    <script src="assets/js/breakpoints.min.js"></script>
    <script src="assets/js/util.js"></script>
    <script src="assets/js/main.js"></script>

    <script>
  // Fixed analysis titles in order
  const fixedAnalysesTitles = [
      "Article Summary",
      "Historical Background",
      "Causal Analysis",
      "Future Projections"
  ];

  // Get user from URL query parameter, e.g. ?user=user1
  function getUserFromUrl() {
      const params = new URLSearchParams(window.location.search);
      return params.get('user');
  }

  // Helper function: generate safe IDs from headlines for fragment links
  function makeSafeId(text) {
      return text.toLowerCase()
                 .replace(/[^\w\s-]/g, '')   // remove punctuation except word chars, spaces, dashes
                 .trim()
                 .replace(/\s+/g, '-');      // replace spaces with hyphens
  }

  function renderAnalyses(sources, allowedHeadlines = null) {
      const container = document.getElementById('analysis-container');
      container.innerHTML = ''; // Clear previous content

      sources.forEach(source => {
          // If allowedHeadlines is provided, filter articles, else show all
          const filteredArticles = allowedHeadlines
              ? source.articles.filter(article => allowedHeadlines.includes(article.headline))
              : source.articles;

          if (filteredArticles.length === 0) return; // skip sources with no articles

          const sourceDiv = document.createElement('div');
          sourceDiv.classList.add('source-block');

          const sourceTitle = document.createElement('h1');
          sourceTitle.textContent = source.name;
          sourceDiv.appendChild(sourceTitle);

          filteredArticles.forEach(article => {
              const articleDiv = document.createElement('div');
              articleDiv.classList.add('article-block');

              const headline = document.createElement('h2');
              headline.textContent = article.headline;
              // Use sanitized id for fragment navigation
              headline.id = makeSafeId(article.headline);
              articleDiv.appendChild(headline);

              if (article.date) {
                  const datePara = document.createElement('div');
                  datePara.classList.add('article-date');
                  datePara.textContent = article.date;
                  articleDiv.appendChild(datePara);
              }

              // Map analysis titles to content for easy lookup
              const analysisMap = {};
              article.analyses.forEach(a => {
                  analysisMap[a.title] = a.content;
              });

              fixedAnalysesTitles.forEach(title => {
                  const analysisDiv = document.createElement('div');
                  analysisDiv.classList.add('analysis-block');

                  const analysisTitle = document.createElement('h3');
                  analysisTitle.textContent = title;
                  analysisDiv.appendChild(analysisTitle);

                  const analysisContent = document.createElement('p');
                  const content = analysisMap[title] ?? "Content missing";
                  analysisContent.innerHTML = '• ' + content
                      .split('•')
                      .map(line => line.trim())
                      .filter(line => line)
                      .join('<br>• ');

                  analysisDiv.appendChild(analysisContent);

                  articleDiv.appendChild(analysisDiv);
              });

              sourceDiv.appendChild(articleDiv);
          });

          container.appendChild(sourceDiv);
      });
  }

  // Main flow
  const currentUser = getUserFromUrl();

  const timestamp = new Date().getTime();
  
  Promise.all([
      fetch('data.json').then(r => { if (!r.ok) throw new Error('Failed to load data.json'); return r.json(); }),
      fetch('users.json').then(r => { if (!r.ok) throw new Error('Failed to load users.json'); return r.json(); })
  ])
  .then(([dataJson, usersJson]) => {
      if (!currentUser) {
          // No user specified — render all articles unfiltered
          renderAnalyses(dataJson.sources);
      } else {
          const allowedHeadlines = usersJson[currentUser];
          if (!allowedHeadlines) {
              throw new Error(`No assignments found for user: ${currentUser}`);
          }
          renderAnalyses(dataJson.sources, allowedHeadlines);
      }

      // Scroll to anchor after rendering is done ---
      if (window.location.hash) {
          const elementId = window.location.hash.substring(1);
          const element = document.getElementById(elementId);
          if (element) {
              // Scroll smoothly to the element
              element.scrollIntoView({ behavior: 'smooth' });
          }
      }
      // -----------------------------------------------------
  })
  .catch(error => {
      console.error('Error loading JSON data:', error);
      const container = document.getElementById('analysis-container');
      container.textContent = 'Failed to load data or user assignments.';
  });
</script>
</body>
</html>
